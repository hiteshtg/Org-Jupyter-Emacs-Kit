#+TITLE: GNU Emacs Config
#+AUTHOR: Hitesh Sharma
#+PROPERTY: header-args :tangle config.el

* Initialize package sources and use-package
#+begin_src emacs-lisp
(require 'package)
(setq package-archives
      '(("melpa" . "https://melpa.org/packages/")
        ("gnu"   . "https://elpa.gnu.org/packages/")
        ("org"   . "https://orgmode.org/elpa/")))
(package-initialize)

(unless package-archive-contents
  (package-refresh-contents))

(unless (package-installed-p 'use-package)
  (package-install 'use-package))

(require 'use-package)
(setq use-package-always-ensure t)
#+end_src

* Dashboard
#+begin_src emacs-lisp
(use-package dashboard
  :config
  (progn
    (setq dashboard-startup-banner "~/.emacs.d/dragon_dashboard.txt"
          dashboard-items '((recents  . 5)
                            (projects . 5)
                            (agenda   . 5))
          initial-buffer-choice (lambda () (get-buffer "*dashboard*")))
    (dashboard-setup-startup-hook)
    (add-hook 'after-make-frame-functions
              (lambda (frame)
                (with-selected-frame frame
                  (dashboard-refresh-buffer))))))
#+end_src

* Theme, Fonts and UI
** Line Numbers
#+begin_src emacs-lisp
(setq display-line-numbers-type 'relative)
(global-display-line-numbers-mode 1)
#+end_src

** Doom Theme
#+begin_src emacs-lisp
(use-package doom-themes
  :init
  (setq doom-themes-enable-bold t
        doom-themes-enable-italic t)
  :config
  (load-theme 'doom-one t))
#+end_src

** All Icons
#+begin_src emacs-lisp
(use-package all-the-icons)
#+end_src

** Remove UI Bars
#+begin_src emacs-lisp
(menu-bar-mode -1)
(tool-bar-mode -1)
(scroll-bar-mode -1)
#+end_src

** Zoom In and Out
#+begin_src emacs-lisp
(global-set-key (kbd "C-=") 'text-scale-increase)
(global-set-key (kbd "C--") 'text-scale-decrease)
#+end_src

* Enhanced M-x and Minibuffer
#+begin_src emacs-lisp
(use-package ivy
  :diminish
  :init
  (ivy-mode 1)
  :bind (("C-s" . swiper)
         :map ivy-minibuffer-map
         ("TAB" . ivy-alt-done)
         ("C-l" . ivy-alt-done)
         ("C-j" . ivy-next-line)
         ("C-k" . ivy-previous-line))
  :config
  (setq ivy-use-virtual-buffers t)
  (setq ivy-count-format "(%d/%d) "))

(use-package counsel
  :after ivy
  :bind (("M-x" . counsel-M-x)
         ("C-x C-f" . counsel-find-file)
         ("C-c k" . counsel-rg)
         ("C-x b" . counsel-switch-buffer))
  :config
  (counsel-mode 1))

(use-package marginalia
  :init (marginalia-mode))
#+end_src

* Auto Completion
** Corfu
#+begin_src emacs-lisp
(use-package corfu
  :init
  (global-corfu-mode)
  (setq corfu-auto t
        corfu-cycle t
        corfu-auto-prefix 2
        corfu-auto-delay 0.2
        corfu-quit-at-boundary t
        corfu-quit-no-match 'separator
        corfu-popupinfo-delay 0.2)
  :bind
  (:map corfu-map
        ("TAB" . corfu-next)
        ([tab] . corfu-next)
        ("S-TAB" . corfu-previous)
        ([backtab] . corfu-previous)
        ("C-g" . corfu-quit)
        ("<escape>" . corfu-quit))
  :config
  (require 'corfu-popupinfo)
  (corfu-popupinfo-mode 1))
#+end_src

** Cape
#+begin_src emacs-lisp
(defun my/cape-yasnippet ()
  "Completion-at-point function for Yasnippet with prefix filtering."
  (require 'yasnippet)
  (when (and (bound-and-true-p yas-minor-mode)
             (yas--get-snippet-tables))
    (let ((start (max (point-min)
                      (save-excursion
                        (skip-chars-backward "[:word:]_-")
                        (point)))))
      (list start (point)
            (completion-table-dynamic
             (lambda (input)
               (let* ((table (yas--get-snippet-tables))
                      (snippets (mapcar #'yas--template-key
                                        (yas--all-templates table)))
                      (completion-list (cl-remove-if-not #'identity snippets)))
                 (cl-remove-if-not
                  (lambda (c) (string-prefix-p input c))
                  completion-list))))
            :annotation-function (lambda (s) (concat " [YAS]"))
            :company-kind (lambda (_) 'snippet)
            :exclusive 'no))))

(use-package cape
  :config
  (defun my/setup-cape ()
    (let ((capfs
           (list #'cape-dabbrev
                 #'cape-file
                 #'cape-keyword
                 #'my/cape-yasnippet)))
      (when (fboundp 'cape-symbol)
        (push #'cape-symbol capfs))
      (setq-local completion-at-point-functions capfs)))
  :hook ((prog-mode . my/setup-cape)
         (org-mode . my/setup-cape)))
#+end_src

** Electric Pair
#+begin_src emacs-lisp
(electric-pair-mode 1)
#+end_src

* LSP Support
#+begin_src emacs-lisp
(use-package lsp-mode
  :hook ((python-mode . lsp)
         (rust-mode   . lsp))
  :commands lsp
  :init
  (setq lsp-completion-provider :none))
#+end_src

* Org + Jupyter + Python
#+begin_src emacs-lisp
(setq org-confirm-babel-evaluate nil)
(setq python-shell-interpreter "python3")

(defvar my/org-src-fake-file "~/.org-src-fake/main.py"
  "Fake file path to trick LSP for org-babel Python blocks.")

(unless (file-exists-p my/org-src-fake-file)
  (make-directory (file-name-directory my/org-src-fake-file) t)
  (with-temp-buffer (write-file my/org-src-fake-file)))

(with-eval-after-load 'lsp-mode
  (setq lsp-disabled-clients '(pyls-ms pyright)
        lsp-enabled-clients '(pylsp)
        lsp-auto-guess-root t
        lsp-session-file (expand-file-name ".lsp-session-v1" user-emacs-directory))

  (defun my/org-src--setup-lsp-buffer ()
    (when (and (eq major-mode 'python-mode)
               (not (bound-and-true-p lsp-mode)))
      (setq buffer-file-name my/org-src-fake-file)
      (lsp)))

  (defun my/org-src--unset-fake-file-name ()
    (when (equal buffer-file-name my/org-src-fake-file)
      (setq buffer-file-name nil)))

  (add-hook 'org-src-mode-hook #'my/org-src--setup-lsp-buffer)
  (add-hook 'org-src-mode-exit-hook #'my/org-src--unset-fake-file-name))

(add-to-list 'load-path "~/.emacs.d/man_installed/emacs-jupyter")
(use-package jupyter
  :defer t
  :init
  (with-eval-after-load 'org
    (require 'ob-jupyter)
    (org-babel-do-load-languages
     'org-babel-load-languages
     '((emacs-lisp . t)
       (python . t)
       (jupyter . t))))
  :config
  (setq org-babel-default-header-args:jupyter-python
        '((:session . "py")
          (:kernel . "python3")
          (:exports . "both")
          (:results . "output"))))

(add-to-list 'load-path "~/.emacs.d/man_installed/ox-ipynb/")
(require 'ox-ipynb)

(defun my/org-safe-jupyter-wrapper (orig-fn &rest args)
  "Only call jupyter-org functions if in Org mode."
  (if (derived-mode-p 'org-mode)
      (apply orig-fn args)
    nil))

(with-eval-after-load 'jupyter
  (advice-add 'jupyter-org--with-src-block-client :around #'my/org-safe-jupyter-wrapper))
#+end_src

* Inline Images
#+begin_src emacs-lisp
(add-hook 'org-babel-after-execute-hook
          (lambda ()
            (when (derived-mode-p 'org-mode)
              (org-display-inline-images))))

(setq org-startup-with-inline-images t)
#+end_src

* Git Client
#+begin_src emacs-lisp
(use-package magit)
#+end_src

* Snippets
#+begin_src emacs-lisp
(use-package yasnippet
  :config (yas-global-mode 1))

(use-package yasnippet-snippets)
#+end_src

* Org Mode
#+begin_src emacs-lisp
(use-package org)
#+end_src

* File Stuff
** Disable Backup Files
#+begin_src emacs-lisp
(setq make-backup-files nil)
#+end_src
